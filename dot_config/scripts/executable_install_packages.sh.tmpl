#!/bin/bash

set -e

DRY_RUN=false

# Parse arguments
for arg in "$@"; do
    case "$arg" in
        --dry-run|-n)
            DRY_RUN=true
            ;;
    esac
done

echo "ğŸ” Detecting OS..."

SOURCE_DIR="{{ .chezmoi.sourceDir }}/dot_config"
BREW_FILE="$SOURCE_DIR/packages/brew.txt"
BREW_CASK_FILE="$SOURCE_DIR/packages/brew_cask.txt.tmpl"
DNF_FILE="$SOURCE_DIR/packages/dnf.txt"
INSTALL_CMDS="{{ .chezmoi.homeDir }}/.config/scripts/install_commands.sh"

if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "ğŸ–¥ macOS detected"

    if ! command -v brew &>/dev/null; then
        echo "ğŸº Homebrew not found. Installing..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    echo ""
    echo "ğŸ“¦ Installing Homebrew packages from brew.txt..."
    while IFS= read -r package || [[ -n "$package" ]]; do
        [[ -z "$package" || "$package" =~ ^# ]] && continue
        if [ "$DRY_RUN" = true ]; then
            echo "ğŸ” [DRY-RUN] Would install: $package"
        else
            echo "ğŸ“¦ Installing: $package"
            brew install "$package" || echo "âš ï¸ Failed to install $package"
        fi
    done < "BREW_FILE"

    echo ""
    echo "ğŸ¾ Installing Homebrew cask packages from brew_cask.txt..."
    while IFS= read -r cask || [[ -n "$cask" ]]; do
        [[ -z "$cask" || "$cask" =~ ^# ]] && continue
        if [ "$DRY_RUN" = true ]; then
            echo "ğŸ” [DRY-RUN] Would install cask: $cask"
        else
            echo "ğŸ¾ Installing cask: $cask"
            brew install --cask "$cask" || echo "âš ï¸ Failed to install cask $cask"
        fi
    done < "$BREW_CASK_FILE"

elif [ -f /etc/fedora-release ]; then
    echo "ğŸ§ Fedora detected"

    echo "ğŸ“¦ Installing DNF packages from dnf.txt..."
    mapfile -t dnf_packages < <(grep -vE '^\s*#' "$DNF_FILE")

    if [ "$DRY_RUN" = true ]; then
        for pkg in "${dnf_packages[@]}"; do
            echo "ğŸ” [DRY-RUN] Would install: $pkg"
        done
    else
        sudo dnf install -y "${dnf_packages[@]}"
    fi

    # Install certain packages via shell commands.
    $INSTALL_CMDS

else
    echo "âŒ Unsupported OS: $OSTYPE"
    exit 1
fi


echo ""
echo "âœ… Package installation script complete!"

